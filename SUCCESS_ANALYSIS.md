# ğŸ‰ Isaac Lab æ¨¡å‹éƒ¨ç½²åˆ° MuJoCo æˆåŠŸåˆ†æ

## é—®é¢˜å›é¡¾

**æ¨¡å‹**: `model_23599.pt` (23599 iterations)  
**è®­ç»ƒç¯å¢ƒ**: RobotLab-Isaac-Velocity-Rough-Unitree-Go2-v0  
**åˆå§‹ç°è±¡**: æœºå™¨äººèƒ½ç«™ç«‹ä½†å®Œå…¨ä¸åŠ¨ï¼Œæ— è®ºå¦‚ä½•å‘é€å‰è¿›å‘½ä»¤éƒ½æ²¡æœ‰ååº”

## å…³é”®ä¿®å¤ - ä¸¤ä¸ªè‡´å‘½BUG

### ğŸ”´ **BUG #1: base_quat åˆå§‹åŒ–é”™è¯¯** (æœ€å…³é”®ï¼)

**ä½ç½®**: `src/rl_sar/library/core/rl_sdk/rl_sdk.cpp` Line 220

**é”™è¯¯ä»£ç **:
```cpp
this->obs.base_quat = {0.0f, 0.0f, 0.0f, 1.0f};  // âŒ é”™è¯¯çš„å››å…ƒæ•°ï¼
```

**ä¿®å¤ä»£ç **:
```cpp
this->obs.base_quat = {1.0f, 0.0f, 0.0f, 0.0f};  // âœ… [w, x, y, z] æ­£ç¡®çš„å•ä½å››å…ƒæ•°
```

**ä¸ºä»€ä¹ˆè¿™æ˜¯è‡´å‘½çš„**:
1. **å››å…ƒæ•°æ ¼å¼**: ä»£ç ä½¿ç”¨ `[w, x, y, z]` æ ¼å¼ï¼Œå•ä½å››å…ƒæ•°åº”è¯¥æ˜¯ `[1, 0, 0, 0]`ï¼Œè€Œä¸æ˜¯ `[0, 0, 0, 1]`
2. **gravity_vec å˜æ¢å¤±è´¥**: é‡åŠ›å‘é‡éœ€è¦é€šè¿‡ `QuatRotateInverse(base_quat, [0, 0, -1])` ä»ä¸–ç•Œåæ ‡ç³»è½¬æ¢åˆ°æœºä½“åæ ‡ç³»
3. **é”™è¯¯çš„å››å…ƒæ•°å¯¼è‡´é”™è¯¯çš„é‡åŠ›æŠ•å½±**:
   - é”™è¯¯çš„åˆå§‹åŒ–: `gravity_vec = [0.00, -0.00, -1.00]` (åº”è¯¥æ˜¯ `[0, 0, -1]`)
   - åœ¨è§‚æµ‹å‘é‡ä¸­ gravity_vec å‡ ä¹ä¸º0ï¼
4. **ç­–ç•¥å®Œå…¨å¤±æ•ˆ**: Isaac Lab è®­ç»ƒæ—¶ gravity_vec æ˜¯å…³é”®è§‚æµ‹ï¼Œç”¨äºåˆ¤æ–­æœºå™¨äººå§¿æ€ã€‚é”™è¯¯çš„é‡åŠ›å‘é‡ â†’ ç­–ç•¥æ— æ³•åˆ¤æ–­å§¿æ€ â†’ è¾“å‡ºä¿å®ˆåŠ¨ä½œï¼ˆä¸åŠ¨ï¼‰

**è°ƒè¯•è¯æ®**:
```
ä¿®å¤å‰:
[DEBUG GRAVITY] base_quat: [0.00, 0.00, 0.00, 1.00]  â† é”™è¯¯ï¼
[DEBUG GRAVITY] After transform: [0.00, -0.00, -1.00]  â† æŠ•å½±é”™è¯¯
è§‚æµ‹å‘é‡ [3-5]: -0.00 0.00 -0.00  â† gravity_vecå‡ ä¹ä¸º0

ä¿®å¤å:
[DEBUG GRAVITY] base_quat: [1.00, 0.00, 0.00, 0.00]  â† æ­£ç¡®ï¼
[DEBUG GRAVITY] After transform: [0.00, 0.00, -1.00]  â† æŠ•å½±æ­£ç¡®
è§‚æµ‹å‘é‡ [3-5]: 0.00 0.00 -1.00  â† gravity_vecæ­£ç¡®
```

---

### ğŸ”´ **BUG #2: å‘½ä»¤å€¼è¶…å‡ºè®­ç»ƒèŒƒå›´**

**ä½ç½®**: `src/rl_sar/library/core/rl_sdk/rl_sdk.cpp` Lines 61-65

**é—®é¢˜**: 
- é”®ç›˜æ§åˆ¶æ¯æ¬¡æŒ‰ `w` å¢åŠ  0.1ï¼Œå¯ä»¥æ— é™ç´¯åŠ 
- ä¹‹å‰æµ‹è¯•ä¸­å‘½ä»¤è¾¾åˆ° **1451.74** (è¶…å‡ºè®­ç»ƒèŒƒå›´1400å¤šå€ï¼)
- Isaac Lab è®­ç»ƒæ—¶å‘½ä»¤èŒƒå›´: `[-1.0, 1.0]` m/s

**ä¿®å¤ä»£ç **:
```cpp
// CRITICAL: Clip commands to Isaac Lab training range [-1.0, 1.0]
this->control.x = std::clamp(this->control.x, -1.0f, 1.0f);
this->control.y = std::clamp(this->control.y, -1.0f, 1.0f);
this->control.yaw = std::clamp(this->control.yaw, -1.0f, 1.0f);
```

**ä¸ºä»€ä¹ˆé‡è¦**:
- ç­–ç•¥æ˜¯åœ¨ `[-1.0, 1.0]` èŒƒå›´å†…è®­ç»ƒçš„ï¼Œè¶…å‡ºæ­¤èŒƒå›´çš„è¾“å…¥å®Œå…¨è¶…å‡ºåˆ†å¸ƒ
- è™½ç„¶è¿™ä¸ªbugå•ç‹¬å¯èƒ½ä¸è‡´å‘½ï¼Œä½†ä¼šå¯¼è‡´ç­–ç•¥è¡Œä¸ºä¸ç¨³å®š

---

## å“ªä¸ªä¿®å¤æœ€å…³é”®ï¼Ÿ

### **ç­”æ¡ˆ: base_quat åˆå§‹åŒ– (BUG #1) æ˜¯æ ¹æœ¬åŸå› ï¼**

**è¯æ®é“¾**:

1. **gravity_vec æ˜¯æ ¸å¿ƒè§‚æµ‹**
   - åœ¨ 45 ç»´è§‚æµ‹ç©ºé—´ä¸­å æ® [3-5] ä½ç½®ï¼ˆç¬¬2ç»„è§‚æµ‹ï¼‰
   - Isaac Lab è®­ç»ƒæ—¶ç”¨äºåˆ¤æ–­æœºå™¨äººå€¾æ–œã€ç¿»æ»šç­‰å§¿æ€ä¿¡æ¯
   - å¯¹äºå››è¶³æœºå™¨äººæ­¥æ€æ§åˆ¶è‡³å…³é‡è¦

2. **é”™è¯¯çš„ base_quat å¯¼è‡´é”™è¯¯çš„ gravity æŠ•å½±**
   ```
   world_gravity = [0, 0, -1]  (ä¸–ç•Œåæ ‡ç³»ï¼Œzè½´å‘ä¸‹)
   â†“ QuatRotateInverse(base_quat, gravity)
   body_gravity = åº”è¯¥æ˜¯ [0, 0, -1] (æœºå™¨äººç›´ç«‹æ—¶)
                  å®é™…æ˜¯ [~0, ~0, ~0]  (å‡ ä¹ä¸º0ï¼)
   ```

3. **ç­–ç•¥çœ‹åˆ°é”™è¯¯çš„è§‚æµ‹**
   ```
   è®­ç»ƒæ—¶çœ‹åˆ°: gravity_vec â‰ˆ [0, 0, -1] è¡¨ç¤º"æˆ‘ç«™ç›´äº†"
   éƒ¨ç½²æ—¶çœ‹åˆ°: gravity_vec â‰ˆ [0, 0, 0]   è¡¨ç¤º"é‡åŠ›æ¶ˆå¤±äº†ï¼Ÿï¼"
   
   ç­–ç•¥ååº”: "è¿™ä¸æ˜¯æˆ‘è®­ç»ƒæ—¶è§è¿‡çš„æƒ…å†µï¼Œä¿æŒä¸åŠ¨æœ€å®‰å…¨"
   ```

4. **ç¬¬ä¸€ä¸ªæ—¶é—´æ­¥å°±é”™äº†**
   - `InitObservations()` åœ¨ FSM åˆ‡æ¢åˆ° RLLocomotion æ—¶è°ƒç”¨
   - ç¬¬ä¸€æ¬¡æ¨ç†å°±ä½¿ç”¨äº†é”™è¯¯çš„ base_quat
   - æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ gravity_vec éƒ½æ˜¯é”™çš„

---

## ä¸ºä»€ä¹ˆè°ƒè¯•è¿™ä¹ˆä¹…ï¼Ÿ

1. **éšè”½æ€§é«˜**: 
   - æœºå™¨äººèƒ½æ­£å¸¸ç«™ç«‹ï¼ˆGetUp FSM æ­£å¸¸ï¼‰
   - æ¨¡å‹åŠ è½½æˆåŠŸï¼Œæ— æŠ¥é”™
   - è§‚æµ‹ç»´åº¦æ­£ç¡®ï¼ˆ45ç»´ï¼‰
   - åªæœ‰ä»”ç»†æ£€æŸ¥è§‚æµ‹å€¼æ‰èƒ½å‘ç° gravity_vec â‰ˆ 0

2. **è¡¨é¢ç°è±¡è¯¯å¯¼**:
   - ä¸€å¼€å§‹ä»¥ä¸ºæ˜¯é…ç½®é—®é¢˜ï¼ˆYAMLæ ¼å¼ã€observationé¡ºåºï¼‰
   - ç„¶åæ€€ç–‘æ˜¯å‘½ä»¤å€¼é—®é¢˜ï¼ˆç¡®å®ä¹Ÿæœ‰é—®é¢˜ï¼‰
   - æœ€åæ‰å‘ç°æ˜¯è§‚æµ‹æ•°æ®æœ¬èº«çš„é—®é¢˜

3. **è°ƒè¯•è¿‡ç¨‹**:
   ```
   ç¬¬1å¤©: YAMLé…ç½®ä¿®å¤
   ç¬¬2å¤©: è§‚æµ‹ç©ºé—´é¡ºåºä¿®å¤
   ç¬¬3å¤©: é”®ç›˜æ§åˆ¶è‡ªåŠ¨åŒ–
   ç¬¬4å¤©: å‘ç°å‘½ä»¤å€¼è¿‡å¤§ â†’ æ·»åŠ clipping
   ç¬¬5å¤©: æ·»åŠ gravity_vecè°ƒè¯• â†’ å‘ç°base_quaté”™è¯¯ â†’ ä¿®å¤ â†’ æˆåŠŸï¼
   ```

---

## æŠ€æœ¯ç»†èŠ‚

### å››å…ƒæ•°çº¦å®š
```cpp
// [w, x, y, z] æ ¼å¼
å•ä½å››å…ƒæ•° (identity) = [1, 0, 0, 0]  â† è¡¨ç¤ºæ— æ—‹è½¬

// å¸¸è§é”™è¯¯
æœ‰äº›åº“ç”¨ [x, y, z, w] æ ¼å¼ï¼Œå…¶ä¸­ identity = [0, 0, 0, 1]
ä½†è¿™ä¸ªä»£ç åº“æ˜ç¡®ä½¿ç”¨ [w, x, y, z]ï¼
```

### é‡åŠ›å‘é‡å˜æ¢
```cpp
world_gravity = [0, 0, -1]  // ä¸–ç•Œåæ ‡ç³» (MuJoCo: zè½´å‘ä¸Šï¼Œé‡åŠ›-zæ–¹å‘)
body_gravity = QuatRotateInverse(base_quat, world_gravity)

// æœºå™¨äººç›´ç«‹æ—¶:
base_quat = [1, 0, 0, 0] (æ— æ—‹è½¬)
body_gravity = [0, 0, -1]  (æœºä½“åæ ‡ç³»çš„é‡åŠ›ä¹Ÿæ˜¯-zæ–¹å‘)

// æœºå™¨äººå€¾æ–œæ—¶:
base_quat = [w, x, y, z] (æœ‰æ—‹è½¬)
body_gravity = [gx, gy, gz]  (æœºä½“æ„Ÿå—åˆ°çš„é‡åŠ›æ–¹å‘æ”¹å˜)
```

### Isaac Lab è§‚æµ‹ç©ºé—´
```python
# è®­ç»ƒé…ç½® (45ç»´ï¼Œæ—  base_lin_vel)
observations:
  - ang_vel      (3) â† è§’é€Ÿåº¦ * 0.25
  - gravity_vec  (3) â† æœºä½“åæ ‡ç³»é‡åŠ›å‘é‡ â­ å…³é”®ï¼
  - commands     (3) â† é€Ÿåº¦å‘½ä»¤ [vx, vy, vyaw]
  - dof_pos      (12) â† å…³èŠ‚ä½ç½® - default
  - dof_vel      (12) â† å…³èŠ‚é€Ÿåº¦ * 0.05
  - actions      (12) â† ä¸Šä¸€æ—¶åˆ»åŠ¨ä½œ
```

---

## ç»éªŒæ•™è®­

### âœ… **æ­£ç¡®çš„è°ƒè¯•é¡ºåº**:
1. å…ˆéªŒè¯é…ç½®å®Œå…¨åŒ¹é…ï¼ˆYAMLã€observation orderã€scalingï¼‰
2. å†æ£€æŸ¥æ•°æ®èŒƒå›´æ˜¯å¦åˆç†ï¼ˆcommands clippingï¼‰
3. æœ€åæ£€æŸ¥è§‚æµ‹æ•°æ®çš„å®é™…å€¼ï¼ˆgravity_vecï¼‰
4. **æ°¸è¿œä¸è¦å¿½è§†"æ¥è¿‘0"çš„å¼‚å¸¸å€¼ï¼**

### âœ… **å…³é”®è°ƒè¯•æŠ€å·§**:
1. **æ‰“å°åŸå§‹è§‚æµ‹å€¼** (ä¸ä»…ä»…æ˜¯æ‰“å°ç»´åº¦)
2. **é€æ­¥å¢åŠ è°ƒè¯•è¾“å‡º** (gravity transformation)
3. **å¯¹æ¯”è®­ç»ƒç¯å¢ƒçš„å®é™…æ•°æ®åˆ†å¸ƒ**
4. **ç¬¬ä¸€æ—¶åˆ»çš„è§‚æµ‹æœ€é‡è¦** (åˆå§‹åŒ–bug)

### âœ… **å››å…ƒæ•°ç›¸å…³ä»£ç çš„æ£€æŸ¥æ¸…å•**:
- [ ] ç¡®è®¤å››å…ƒæ•°æ ¼å¼çº¦å®š ([w,x,y,z] vs [x,y,z,w])
- [ ] æ£€æŸ¥å•ä½å››å…ƒæ•°çš„åˆå§‹åŒ–
- [ ] éªŒè¯æ—‹è½¬å˜æ¢çš„æ­£ç¡®æ€§
- [ ] æ‰“å°å˜æ¢å‰åçš„å‘é‡å€¼

---

## æœ€ç»ˆç»“æœ

âœ… **base_quat ä¿®å¤** â†’ gravity_vec æ­£ç¡® â†’ ç­–ç•¥è¯†åˆ«å§¿æ€  
âœ… **commands clipping** â†’ å‘½ä»¤åœ¨è®­ç»ƒèŒƒå›´å†… â†’ ç­–ç•¥å“åº”åˆç†  
âœ… **æœºå™¨äººæˆåŠŸè¡Œèµ°ï¼** ğŸ‰

**ç»“è®º**: **BUG #1 (base_quat) æ˜¯æ ¹æœ¬åŸå› ï¼ŒBUG #2 (commands) æ˜¯æ¬¡è¦é—®é¢˜**

---

## ä»£ç ä¿®æ”¹æ€»ç»“

### æ–‡ä»¶1: `src/rl_sar/library/core/rl_sdk/rl_sdk.cpp`

**ä¿®æ”¹1**: Line 220 (InitObservations)
```cpp
- this->obs.base_quat = {0.0f, 0.0f, 0.0f, 1.0f};
+ this->obs.base_quat = {1.0f, 0.0f, 0.0f, 0.0f};  // [w, x, y, z]
```

**ä¿®æ”¹2**: Lines 61-65 (StateController)
```cpp
+ // CRITICAL: Clip commands to Isaac Lab training range [-1.0, 1.0]
+ this->control.x = std::clamp(this->control.x, -1.0f, 1.0f);
+ this->control.y = std::clamp(this->control.y, -1.0f, 1.0f);
+ this->control.yaw = std::clamp(this->control.yaw, -1.0f, 1.0f);
```

### æ–‡ä»¶2: `policy/go2/robot_lab/config.yaml`

**ä¿®æ”¹**: YAMLæ ¼å¼ä¿®å¤
```yaml
go2/robot_lab:  # æ·»åŠ é¡¶å±‚key
  model_name: "policy_from_23599.pt"
  observations: ["ang_vel", "gravity_vec", "commands", ...]  # é¡ºåºä¿®å¤
```

---

**éƒ¨ç½²æ—¶é—´**: çº¦5å¤©è°ƒè¯•  
**å…³é”®çªç ´**: gravity_vec è°ƒè¯•è¾“å‡ºå‘ç° base_quat åˆå§‹åŒ–é”™è¯¯  
**æˆåŠŸæ ‡å¿—**: æœºå™¨äººå“åº”å‰è¿›å‘½ä»¤ï¼Œæ­¥æ€è‡ªç„¶  

ğŸŠ **æ­å–œæˆåŠŸéƒ¨ç½² Isaac Lab ç­–ç•¥åˆ° MuJoCoï¼** ğŸŠ
